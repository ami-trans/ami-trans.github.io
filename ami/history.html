<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Order History</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
<style>
  body {
    font-family: "Poppins", sans-serif;
    margin: 0;
    background: linear-gradient(135deg, #009B4D, #FFCC00, #009B4D);
    background-size: 300% 300%;
    animation: gradientMove 12s ease infinite;
    min-height: 100vh;
  }
  @keyframes gradientMove {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  .navbar {
    display: flex; justify-content: space-between; align-items: center;
    background: #FAF5E9; padding: 12px 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-radius: 0 0 14px 14px;
  }
  .navbar-left { display: flex; align-items: center; gap: 10px; }
  .navbar-left img { height: 28px; width: 28px; border-radius: 8px; }
  .navbar-left h1 { font-size: 18px; margin:0; color:#009B4D; }
  .btn { background: linear-gradient(135deg,#009B4D,#FFCC00); color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:600; }
  .container { max-width:1000px; margin:20px auto; padding:20px; background: rgba(255,255,255,0.9); border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.15);}
  .controls { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:12px; }
  input[type="text"] { flex:1; padding:6px 10px; border-radius:6px; border:1px solid #ccc; }
  select { padding:6px 10px; border-radius:6px; border:1px solid #ccc; }
  .accordion { background:#fff; border-radius:10px; margin-bottom:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
  .accordion-header { padding:12px 16px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; font-weight:600; }
  .accordion-body { display:none; padding:12px 16px; border-top:1px solid #ddd; }
  .status-step { font-size:14px; margin:4px 0; }
  img.sj-photo { max-width:150px; border-radius:6px; cursor:pointer; margin-top:6px; }
  .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
  .modal img { max-width:90%; max-height:90%; border-radius:10px; }
  .toast { position: fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#009B4D;color:#fff;padding:10px 16px;border-radius:8px;opacity:0; transition: opacity .4s;}
  .toast.show { opacity:1;}
</style>
</head>
<body>

<div class="navbar">
  <div class="navbar-left">
    <img src="https://i.imgur.com/ivZMmoZ.png" alt="logo">
    <h1>Order History</h1>
  </div>
  <button class="btn" onclick="window.location.href='dashboard.html'">← Dashboard</button>
</div>

<div class="container">
  <div class="controls">
    <input type="text" id="searchInput" placeholder="Cari semua kolom..." oninput="applyFilters()"/>
    <select id="rowLimit" onchange="applyFilters()">
      <option value="10">10</option>
      <option value="50">50</option>
      <option value="100">100</option>
      <option value="all">All</option>
    </select>
    <button class="btn" onclick="downloadExcel()">Download Excel</button>
  </div>

  <div id="historyList">Loading...</div>
</div>

<div id="toast" class="toast"></div>
<div id="photoModal" class="modal" onclick="this.style.display='none'">
  <img id="modalImage" src=""/>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const supabaseUrl = "https://yxppbwrfggbgoyaiigjs.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4cHBid3JmZ2diZ295YWlpZ2pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDk2NTEsImV4cCI6MjA3Mzg4NTY1MX0.DBRShZgj4wjMBdS6uqz0-bWtI-oaExNv_lJes4yHP_M"; 
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

let allHistory = [];

async function loadHistory(){
  const {data,error} = await supabase.from("order_history").select("*").order("created_at",{ascending:false});
  if(error){console.error(error); showToast("Gagal load history",false); return;}
  allHistory = data;
  renderHistory();
}

function renderHistory(data = allHistory){
  const container = document.getElementById("historyList");
  const limitVal = document.getElementById("rowLimit").value;
  const limit = limitVal==="all"?data.length:parseInt(limitVal);

  let filtered = data.slice(0,limit);
  container.innerHTML = "";
  if(!filtered.length){container.innerHTML="<p>Tidak ada history.</p>"; return;}

  filtered.forEach(order=>{
    const acc = document.createElement("div");
    acc.className="accordion";

    const header = document.createElement("div");
    header.className="accordion-header";
    header.textContent=`${order.customer_name} (${order.origin} → ${order.destination})`;
    const statusLast = document.createElement("span");
    statusLast.textContent = order.last_status || "";
    header.appendChild(statusLast);
    acc.appendChild(header);

    const body = document.createElement("div");
    body.className="accordion-body";
    body.innerHTML=`
      <div class="status-step"><b>Type Unit:</b> ${order.type_unit}</div>
      <div class="status-step"><b>Price:</b> ${order.price}</div>
      <div class="status-step"><b>Uang Jalan:</b> ${order.uang_jalan}</div>
      <div class="status-step"><b>Tanggal Assign:</b> ${order.tanggal_assign}</div>
      <div class="status-step"><b>Status:</b></div>
      <div class="status-step">Accepted: ${order.accepted_at||"-"}</div>
      <div class="status-step">Mulai Muat: ${order.mulai_muat_at||"-"}</div>
      <div class="status-step">Selesai Muat: ${order.selesai_muat_at||"-"}</div>
      <div class="status-step">Mulai Bongkar: ${order.mulai_bongkar_at||"-"}</div>
      <div class="status-step">Selesai Bongkar: ${order.selesai_bongkar_at||"-"}</div>
      <div class="status-step"><b>Surat Jalan No:</b> ${order.surat_jalan_no||"-"}</div>
      ${order.surat_jalan_foto?`<img src="${order.surat_jalan_foto}" class="sj-photo" onclick="showPhoto('${order.surat_jalan_foto}')">`:"<i>Tidak ada foto</i>"}
    `;
    acc.appendChild(body);
    container.appendChild(acc);

    header.addEventListener("click",()=>{ body.style.display = body.style.display==="block"?"none":"block"; });
  });
}

function applyFilters(){
  const text = document.getElementById("searchInput").value.toLowerCase();
  let filtered = allHistory.filter(o=>{
    return Object.values(o).some(v=>String(v||"").toLowerCase().includes(text));
  });
  renderHistory(filtered);
}

function showPhoto(url){
  document.getElementById("modalImage").src=url;
  document.getElementById("photoModal").style.display="flex";
}

function showToast(msg,success=true){
  const toast=document.getElementById("toast");
  toast.textContent=msg;
  toast.style.background=success?"#009B4D":"#e53935";
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),3000);
}

function downloadExcel(){
  if(!allHistory.length){ showToast("Tidak ada data untuk diunduh",false); return;}
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.json_to_sheet(allHistory);
  XLSX.utils.book_append_sheet(wb,ws,"OrderHistory");
  XLSX.writeFile(wb,"OrderHistory.xlsx");
}

loadHistory();
</script>
</body>
</html>
