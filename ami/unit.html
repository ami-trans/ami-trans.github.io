<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unit - Order</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #009B4D, #FFCC00, #009B4D);
      background-size: 300% 300%;
      animation: gradientMove 12s ease infinite;
      min-height: 100vh;
    }
    @keyframes gradientMove {
      0% { background-position: 0% 50% }
      50% { background-position: 100% 50% }
      100% { background-position: 0% 50% }
    }
    .navbar {
      background: #faf5e9;
      padding: 12px 20px;
      display: flex; justify-content: space-between; align-items: center;
      border-radius: 0 0 14px 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    h1 { font-size: 18px; color: #009B4D; margin: 0; }
    .container { max-width: 900px; margin: 20px auto; background: rgba(255,255,255,0.85); padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
    .order-card { padding: 16px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 14px; background: #fff; }
    .order-card h3 { margin-top: 0; }
    .btn { background: linear-gradient(135deg, #009B4D, #FFCC00); color: #fff; border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-weight: 600; margin: 4px 4px 0 0; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .form-group { margin-top: 10px; }
    label { font-weight: 600; display: block; margin-bottom: 4px; }
    input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
    img.preview { margin-top: 8px; max-width: 200px; display: block; border-radius: 6px; }
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #009B4D; color: #fff; padding: 10px 16px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); opacity: 0; transition: opacity .4s; }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="navbar">
    <h1>Unit Orders</h1>
    <button class="btn" onclick="logout()">Logout</button>
  </div>

  <div class="container">
    <div id="ordersList">Loading...</div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = "https://yxppbwrfggbgoyaiigjs.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4cHBid3JmZ2diZ295YWlpZ2pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDk2NTEsImV4cCI6MjA3Mzg4NTY1MX0.DBRShZgj4wjMBdS6uqz0-bWtI-oaExNv_lJes4yHP_M"; // anon key
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    let currentUnitId = null;

    async function getCurrentUnit() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) {
        window.location.href = "../index.html";
        return;
      }
      currentUnitId = user.id;
      loadOrders();
    }

    function showToast(msg, success = true) {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.style.background = success ? "#009B4D" : "#e53935";
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    async function loadOrders() {
      const { data, error } = await supabaseClient
        .from("orders")
        .select("*")
        .eq("unit_id", currentUnitId)
        .order("created_at", { ascending: false });
      if (error) { console.error(error); return; }

      const container = document.getElementById("ordersList");
      if (!data.length) { container.innerHTML = "<p>Tidak ada order.</p>"; return; }
      container.innerHTML = "";
      data.forEach(order => {
        container.innerHTML += renderOrder(order);
      });
    }

    function renderOrder(order) {
      let actions = "";
      switch(order.status) {
        case "Assignment":
          actions = `<button class="btn" onclick="updateStatus('${order.id}','Accepted')">Terima</button>`;
          break;
        case "Accepted":
          actions = `<button class="btn" onclick="updateStatus('${order.id}','Mulai Muat')">Mulai Muat</button>`;
          break;
        case "Mulai Muat":
          actions = `<button class="btn" onclick="showUpload('${order.id}','Selesai Muat')">Selesai Muat</button>`;
          break;
        case "Selesai Muat":
          actions = `<button class="btn" onclick="updateStatus('${order.id}','Mulai Bongkar')">Mulai Bongkar</button>`;
          break;
        case "Mulai Bongkar":
          actions = `<button class="btn" onclick="showUpload('${order.id}','Selesai Bongkar')">Selesai Bongkar</button>`;
          break;
        case "Selesai Bongkar":
          actions = `<button class="btn" onclick="updateStatus('${order.id}','Standby')">Standby</button>`;
          break;
        case "Standby":
          actions = `<p>Order selesai ✅</p>`;
          break;
      }

      return `
        <div class="order-card" id="order-${order.id}">
          <h3>${order.nama} (${order.origin} → ${order.destination})</h3>
          <p><b>Nopol:</b> ${order.nopol} | <b>Driver:</b> ${order.driver}</p>
          <p><b>Status:</b> ${order.status}</p>
          <div>${actions}</div>
          <div id="upload-${order.id}" style="display:none;margin-top:10px;">
            <div class="form-group">
              <label>No Surat Jalan</label>
              <input type="text" id="sjno-${order.id}">
            </div>
            <div class="form-group">
              <label>Foto Surat Jalan</label>
              <input type="file" id="sjfile-${order.id}" accept="image/*">
              <img id="preview-${order.id}" class="preview" style="display:none;">
            </div>
            <button class="btn" onclick="submitUpload('${order.id}')">Upload & Lanjut</button>
          </div>
        </div>`;
    }

    function showUpload(orderId, nextStep) {
      document.getElementById(`upload-${orderId}`).style.display = "block";
      document.getElementById(`upload-${orderId}`).setAttribute("data-next", nextStep);
      document.getElementById(`sjfile-${orderId}`).addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const preview = document.getElementById(`preview-${orderId}`);
          preview.src = URL.createObjectURL(file);
          preview.style.display = "block";
        }
      });
    }

    async function submitUpload(orderId) {
      const no = document.getElementById(`sjno-${orderId}`).value.trim();
      const file = document.getElementById(`sjfile-${orderId}`).files[0];
      if (!no || !file) { showToast("Isi nomor & upload foto", false); return; }

      const fileName = `${Date.now()}_${file.name}`;
      const { error } = await supabaseClient.storage.from("suratjalan").upload(fileName, file);
      if (error) { showToast("Gagal upload: " + error.message, false); return; }

      const { data: { publicUrl } } = supabaseClient.storage.from("suratjalan").getPublicUrl(fileName);

      const nextStatus = document.getElementById(`upload-${orderId}`).getAttribute("data-next") || "Mulai Bongkar";

      await supabaseClient.from("orders").update({
        surat_jalan_no: no,
        surat_jalan_foto: publicUrl,
        status: nextStatus
      }).eq("id", orderId);

      showToast("Surat jalan diupload");
      loadOrders();
    }

    async function updateStatus(orderId, status) {
      const { error } = await supabaseClient.from("orders").update({ status }).eq("id", orderId);
      if (error) { console.error(error); showToast("Update gagal", false); return; }
      showToast("Status diperbarui");
      loadOrders();
    }

    function logout() {
      supabaseClient.auth.signOut();
      window.location.href = "../index.html";
    }

    getCurrentUnit();
  </script>
</body>
</html>
