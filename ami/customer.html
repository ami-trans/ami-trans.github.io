<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Customers</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    /* Background animated gradient */
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #009B4D, #FFCC00, #009B4D);
      background-size: 300% 300%;
      animation: gradientMove 12s ease infinite;
      min-height: 100vh;
      color: #333;
    }
    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Navbar */
    .navbar {
      display: flex; justify-content: space-between; align-items: center;
      background: #FAF5E9; padding: 10px 18px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      position: sticky; top: 0; z-index: 2000;
      border-radius: 0 0 14px 14px;
    }
    .navbar-left { display: flex; align-items: center; gap: 10px; }
    .navbar-left img { height: 28px; width: 28px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
    .navbar-left h1 { font-size: 18px; font-weight: 600; color: #009B4D; margin: 0; }

    /* Button */
    .btn {
      position: relative; overflow: hidden;
      background: linear-gradient(135deg, #009B4D, #FFCC00);
      color: #fff; border: none; padding: 8px 16px;
      border-radius: 8px; font-weight: 600; cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      transition: transform 0.2s ease;
    }
    .btn:hover { transform: scale(1.05); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .container { max-width: 1100px; margin: 20px auto; padding: 0 14px; }

    /* Add form */
    .add-form {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px; margin-bottom: 16px;
      background: rgba(250,245,233,0.9); padding: 12px; border-radius: 12px;
      backdrop-filter: blur(6px); box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .add-form input, .add-form select {
      width: 100%; padding: 8px 10px;
      border-radius: 8px; border: 1px solid #ccc;
      font-size: 14px;
      transition: border 0.3s ease, box-shadow 0.3s ease;
    }
    .add-form input:focus, .add-form select:focus {
      outline: none; border: 1px solid #009B4D;
      box-shadow: 0 0 6px rgba(0,155,77,0.3);
    }
    .add-form button {
      grid-column: 1 / -1;
      justify-self: start;
    }

    /* Toast */
    .toast {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: #009B4D; color: #fff; padding: 10px 16px;
      border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      opacity: 0; pointer-events: none;
      transition: opacity 0.4s ease;
      font-size: 14px;
    }
    .toast.show { opacity: 1; pointer-events: auto; }

    /* Search */
    .input-wrapper { position: relative; margin-bottom: 16px; }
    .global-search {
      width: 100%; padding: 12px 16px; border-radius: 12px;
      border: 2px solid transparent; font-size: 15px;
      background: rgba(250,245,233,0.85); backdrop-filter: blur(6px);
    }
    .global-search:focus {
      outline: none; border: 2px solid #009B4D;
      box-shadow: 0 0 8px rgba(0,155,77,0.4);
    }
    .clear-btn {
      position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
      background: transparent; border: none; font-size: 18px; cursor: pointer; display: none;
    }

    /* Table */
    .table-container {
      overflow-x: auto; border-radius: 14px;
      background: rgba(250,245,233,0.9); backdrop-filter: blur(12px);
      box-shadow: 4px 4px 12px rgba(0,0,0,0.15), -4px -4px 12px rgba(255,255,255,0.5);
    }
    table { border-collapse: collapse; width: 100%; min-width: 600px; }
    th, td { padding: 10px 14px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.05); }
    th {
      background: linear-gradient(135deg, rgba(0,155,77,0.9), rgba(255,204,0,0.9));
      color: #fff; position: sticky; top: 0; font-weight: 600;
    }
    tr { opacity: 0; transform: translateY(10px); animation: fadeRow 0.5s forwards; }
    @keyframes fadeRow { to { opacity: 1; transform: translateY(0); } }
    tr:hover { background: rgba(255,255,255,0.4); box-shadow: inset 0 0 12px rgba(0,155,77,0.3); transition: all 0.3s ease; }
    .filter-input { width: 100%; padding: 6px; border-radius: 6px; border: none; background: rgba(255,255,255,0.7); font-size: 13px; }

    /* Footer */
    .footer-controls { margin-top: 14px; display: flex; justify-content: flex-end; gap: 8px; flex-wrap: wrap; }
    .footer-controls select {
      padding: 6px 12px; border-radius: 8px; border: none;
      background: rgba(250,245,233,0.9); backdrop-filter: blur(6px);
      box-shadow: 2px 2px 8px rgba(0,0,0,0.15);
    }

    /* FAB */
    .fab {
      position: fixed; bottom: 18px; right: 18px;
      width: 52px; height: 52px; border-radius: 50%; border: none; cursor: pointer;
      background: linear-gradient(135deg, #009B4D, #FFCC00);
      color: #fff; font-size: 20px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
      transition: transform 0.2s ease; display: none;
    }
    .fab:hover { transform: scale(1.1); }

    /* Skeleton */
    .skeleton {
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%; animation: shimmer 1.5s infinite;
      height: 16px; border-radius: 6px;
    }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <div class="navbar-left">
      <img src="https://i.imgur.com/ivZMmoZ.png" alt="icon">
      <h1>Customers</h1>
    </div>
    <button class="btn" onclick="window.location.href='dashboard.html'">‚Üê Dashboard</button>
  </div>

  <div class="container">
    <!-- Add new customer -->
    <form id="addCustomerForm" class="add-form">
      <input type="text" name="nama" placeholder="Nama Customer" required>
      <input type="text" name="origin" placeholder="Origin" required>
      <input type="text" name="destination" placeholder="Destination" required>
      <select name="type_unit" required>
        <option value="">Pilih Type Unit</option>
        <option value="Pickup">CDDL</option>
        <option value="Truck">Fuso</option>
        <option value="Container">Tronton WB</option>
      </select>
      <input type="number" name="price" placeholder="Harga (Rp)" min="0" required>
      <input type="number" name="uang_jalan" placeholder="Uang Jalan (Rp)" min="0" required>
      <button type="submit" class="btn">Tambah Customer</button>
    </form>

    <!-- Search -->
    <div class="input-wrapper">
      <input type="text" id="globalSearch" class="global-search" placeholder="üîç Cari di semua kolom...">
      <button id="clearSearch" class="clear-btn">&times;</button>
    </div>

    <!-- Table -->
    <div class="table-container">
      <table id="customersTable">
        <thead>
          <tr id="tableHead"></tr>
          <tr id="filterRow"></tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="6"><div class="skeleton" style="height:20px;width:80%"></div></td></tr>
          <tr><td colspan="6"><div class="skeleton" style="height:20px;width:60%"></div></td></tr>
          <tr><td colspan="6"><div class="skeleton" style="height:20px;width:70%"></div></td></tr>
        </tbody>
      </table>
    </div>

    <!-- Footer -->
    <div class="footer-controls">
      <label for="rowsPerPage">Tampilkan:</label>
      <select id="rowsPerPage">
        <option value="10">10 data</option>
        <option value="50">50 data</option>
        <option value="100">100 data</option>
        <option value="all">All</option>
      </select>
    </div>
  </div>

  <!-- FAB -->
  <button class="fab" id="scrollTopBtn">‚Üë</button>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = "https://yxppbwrfggbgoyaiigjs.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4cHBid3JmZ2diZ295YWlpZ2pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMDk2NTEsImV4cCI6MjA3Mzg4NTY1MX0.DBRShZgj4wjMBdS6uqz0-bWtI-oaExNv_lJes4yHP_M";
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    let allData = [];
    let headers = [];
    let rowsPerPage = 10;

    function showToast(msg, success = true) {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.style.background = success ? "#009B4D" : "#e53935";
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    async function loadCustomers() {
      const { data, error } = await supabaseClient.from("customers").select("*");
      if (error) { console.error(error); showToast("Gagal ambil data", false); return; }
      if (!data || !data.length) {
        document.getElementById("tableBody").innerHTML = "<tr><td colspan='6'>No data</td></tr>";
        return;
      }

      allData = data;
      headers = Object.keys(data[0] || {});
      headers = headers.filter(h => h !== "id" && h !== "created_at");

      document.getElementById("tableHead").innerHTML =
        headers.map(h => `<th>${h}</th>`).join("");
      document.getElementById("filterRow").innerHTML =
        headers.map(h => `<td><input type="text" class="filter-input" data-col="${h}" placeholder="Filter ${h}"></td>`).join("");

      document.querySelectorAll(".filter-input").forEach(input => input.addEventListener("input", applyFilters));
      document.getElementById("globalSearch").addEventListener("input", applyFilters);
      document.getElementById("rowsPerPage").addEventListener("change", (e) => {
        rowsPerPage = e.target.value === "all" ? "all" : parseInt(e.target.value);
        applyFilters();
      });
      document.getElementById("clearSearch").addEventListener("click", () => {
        document.getElementById("globalSearch").value = "";
        applyFilters();
      });

      applyFilters();
    }

    function formatNumber(num) {
      if (num === null || num === undefined || num === "") return "";
      return new Intl.NumberFormat("id-ID").format(num);
    }

    function renderTable(data) {
      const tableBody = document.getElementById("tableBody");
      let sliced = rowsPerPage === "all" ? data : data.slice(0, rowsPerPage);
      tableBody.innerHTML = sliced.map((row,i) =>
        `<tr style="animation-delay:${i * 0.05}s">
          ${headers.map(h => {
            if (h === "price" || h === "uang_jalan") {
              return `<td>${formatNumber(row[h])}</td>`;
            }
            return `<td>${row[h] ?? ""}</td>`;
          }).join("")}
        </tr>`
      ).join("");
    }

    function applyFilters() {
      let filtered = [...allData];
      const globalValue = document.getElementById("globalSearch").value.toLowerCase();
      if (globalValue) {
        filtered = filtered.filter(row => headers.some(h => String(row[h] ?? "").toLowerCase().includes(globalValue)));
        document.getElementById("clearSearch").style.display = "block";
      } else {
        document.getElementById("clearSearch").style.display = "none";
      }
      document.querySelectorAll(".filter-input").forEach(input => {
        const col = input.dataset.col;
        const val = input.value.toLowerCase();
        if (val) {
          filtered = filtered.filter(row => String(row[col] ?? "").toLowerCase().includes(val));
        }
      });
      renderTable(filtered);
    }

    // Add new customer
    document.getElementById("addCustomerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const btn = form.querySelector("button");
      btn.disabled = true;
      btn.textContent = "Loading...";

      const formData = Object.fromEntries(new FormData(form).entries());
      formData.price = parseFloat(formData.price);
      formData.uang_jalan = parseFloat(formData.uang_jalan);

      const { error } = await supabaseClient.from("customers").insert([formData]);
      if (error) {
        showToast("Gagal tambah data: " + error.message, false);
      } else {
        showToast("Customer berhasil ditambahkan");
        form.reset();
        form.querySelector("input[name='nama']").focus();
        loadCustomers();
      }

      btn.disabled = false;
      btn.textContent = "Tambah Customer";
    });

    // FAB
    const scrollBtn = document.getElementById("scrollTopBtn");
    window.addEventListener("scroll", () => {
      scrollBtn.style.display = window.scrollY > 300 ? "block" : "none";
    });
    scrollBtn.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    loadCustomers();
  </script>
</body>
</html>
