<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kasir - Verifikasi Order</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #009B4D, #FFCC00, #009B4D);
      background-size: 300% 300%;
      animation: gradientMove 12s ease infinite;
      min-height: 100vh; padding: 20px;
    }
    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    h2 { text-align: center; color: #fff; margin-bottom: 20px; }
    .container {
      background: rgba(250,245,233,0.95);
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-width: 1100px;
      margin: auto;
      overflow-x: auto;
    }
    table { border-collapse: collapse; width: 100%; }
    th, td {
      padding: 10px; text-align: center;
      border: 1px solid #ccc; font-size: 14px;
    }
    th { background: #009B4D; color: #fff; }
    button {
      padding: 6px 12px;
      border: none; border-radius: 6px;
      cursor: pointer; font-weight: 600;
      background: linear-gradient(135deg, #009B4D, #FFCC00);
      color: #fff; transition: transform .2s;
    }
    button:hover { transform: scale(1.05); }
    img { max-width: 100px; border-radius: 6px; cursor: pointer; }
    .zoom {
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.8); display:none;
      justify-content: center; align-items: center; z-index: 9999;
    }
    .zoom img { max-width: 90%; max-height: 90%; border-radius: 12px; }
  </style>
</head>
<body>
  <h2>Verifikasi Surat Jalan - Kasir</h2>
  <div class="container">
    <table>
      <thead>
        <tr>
          <th>Customer</th>
          <th>Origin</th>
          <th>Destination</th>
          <th>Type Unit</th>
          <th>Price</th>
          <th>Uang Jalan</th>
          <th>Tanggal</th>
          <th>Nopol</th>
          <th>Driver</th>
          <th>No Surat Jalan</th>
          <th>Foto Surat Jalan</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- Preview zoom -->
  <div id="zoomBox" class="zoom" onclick="this.style.display='none'">
    <img id="zoomImg" src="" alt="Preview Surat Jalan"/>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = "https://yxppbwrfggbgoyaiigjs.supabase.co";
    const supabaseKey = "YOUR_PUBLIC_ANON_KEY"; // ganti dengan anon key kamu
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    async function initKasir() {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error || !user) {
        alert("Silakan login ulang");
        window.location.href = "../index.html";
        return;
      }

      const { data: profile, error: profileError } = await supabase
        .from("profiles")
        .select("id, role, nama")
        .eq("id", user.id)
        .single();

      if (profileError || !profile || profile.role !== "kasir") {
        alert("Kamu bukan kasir!");
        window.location.href = "../index.html";
        return;
      }

      console.log("✅ Login sebagai Kasir:", profile.nama);
      loadOrders();
    }

    async function loadOrders() {
      const { data, error } = await supabase
        .from("orders")
        .select("*")
        .eq("status", "Selesai Muat")
        .order("created_at", { ascending: false });

      const tbody = document.getElementById("tableBody");
      if (error) {
        tbody.innerHTML = "<tr><td colspan='12'>Gagal ambil data</td></tr>";
        return;
      }
      if (!data || data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='12'>Belum ada order menunggu verifikasi</td></tr>";
        return;
      }

      tbody.innerHTML = data.map(o => `
        <tr>
          <td>${o.nama}</td>
          <td>${o.origin}</td>
          <td>${o.destination}</td>
          <td>${o.type_unit}</td>
          <td>${new Intl.NumberFormat("id-ID").format(o.price)}</td>
          <td>${new Intl.NumberFormat("id-ID").format(o.uang_jalan)}</td>
          <td>${o.tanggal ? new Date(o.tanggal).toLocaleString("id-ID") : "-"}</td>
          <td>${o.nopol}</td>
          <td>${o.driver}</td>
          <td>${o.surat_jalan_no || "-"}</td>
          <td>${o.surat_jalan_foto ? `<img src="${o.surat_jalan_foto}" onclick="zoomImg('${o.surat_jalan_foto}')"/>` : "-"}</td>
          <td><button onclick="doneOrder('${o.id}')">Done</button></td>
        </tr>
      `).join("");
    }

    function zoomImg(url) {
      document.getElementById("zoomImg").src = url;
      document.getElementById("zoomBox").style.display = "flex";
    }

    async function doneOrder(orderId) {
      if (!confirm("Apakah order ini sudah benar dan selesai diverifikasi?")) return;
      const { error } = await supabase.from("orders").update({ status: "Kasir Done" }).eq("id", orderId);
      if (error) {
        alert("Gagal update: " + error.message);
      } else {
        alert("✅ Order sudah diverifikasi Kasir.");
        loadOrders();
      }
    }

    initKasir();
  </script>
</body>
</html>
